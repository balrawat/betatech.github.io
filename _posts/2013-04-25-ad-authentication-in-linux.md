---
layout: post
title: AD Authentication in Linux
date: '2013-04-25T13:20:00.002+05:30'
author: Balvinder Rawat
tags:
  - windows
  - linux
  - AD authentication
modified_time: '2013-11-22T18:26:32.137+05:30'
thumbnail: >-
  https://2.bp.blogspot.com/-uAyVMxYPKvY/Uo9UF4ztGrI/AAAAAAAAArA/JztgrPe8l1g/s72-c/adauth.png
blogger_id: 'tag:blogger.com,1999:blog-6814921223515313000.post-1690338798959393670'
blogger_orig_url: 'https://www.linuxtechtips.com/2013/04/ad-authentication-in-linux.html'
---
![](https://2.bp.blogspot.com/-uAyVMxYPKvY/Uo9UF4ztGrI/AAAAAAAAArA/JztgrPe8l1g/s1600/adauth.png)

Recently I was working on a project to add linux machines ( Clients ) to a Windows Active Directory Server. When I started, I saw many blog post for that, some of them were not working & some were working to some extent. I tried a combination of them & succeeded in connecting a Linux client to Windows Domain ( AD ).

Following are the steps I followed which got the Linux Client into Windows domain:-

Before we start, we needed some basic info about the environment:-

<table border="0" cellpadding="0" cellspacing="0" style="border-collapse: collapse; text-align: justify; width: 744px;"><tbody><tr height="60" style="height: 45.0pt;"><td class="xl65" height="60" style="height: 45.0pt; width: 62pt;" width="83"><span style="font-family: Verdana, sans-serif;">Required</span></td><td class="xl64" style="width: 496pt;" width="661"><span style="font-family: Verdana, sans-serif;"># Active Directory Server with the users &amp; groups already setup<br># KDC server name (FQDN)<br># Credentials of a User(administrator) who can join a client machine to AD</span></td></tr></tbody></table>

<table border="0" cellpadding="0" cellspacing="0" style="border-collapse: collapse; text-align: justify; width: 661px;"><colgroup><col style="mso-width-alt: 24173; mso-width-source: userset; width: 496pt;" width="661"></colgroup><tbody><tr height="20" style="height: 15.0pt;"><td class="xl65" height="20" style="height: 15.0pt; width: 496pt;" width="661"><b><span style="font-family: Verdana, sans-serif;">IMPORTANT:</span></b></td></tr><tr height="40" style="height: 30.0pt;"><td class="xl66" height="40" style="height: 30.0pt; width: 496pt;" width="661"><span style="font-family: Verdana, sans-serif;">Make sure the AD &amp; your linux client have time sync. Means any noticeable time difference may cause login delays</span></td></tr></tbody></table>

<table border="0" cellpadding="0" cellspacing="0" style="border-collapse: collapse; text-align: justify; width: 661px;"><tbody><tr height="25" style="height: 18.75pt;"><td class="xl65" height="25" style="height: 18.75pt; width: 496pt;" width="661"><b><span style="font-family: Verdana, sans-serif;">STEPS FOR CONFIGURING LINUX CLIENT TO JOIN ACTIVE DIRECTORY (AD):</span></b><br><table border="0" cellpadding="0" cellspacing="0" style="border-collapse: collapse; width: 744px;"><colgroup><col style="mso-width-alt: 3035; mso-width-source: userset; width: 62pt;" width="83"> <col style="mso-width-alt: 24173; mso-width-source: userset; width: 496pt;" width="661"></colgroup><tbody><tr height="20" style="height: 15.0pt;"><td class="xl78" height="40" rowspan="2" style="border-bottom: .5pt solid black; height: 30.0pt; width: 62pt;" width="83"><span style="font-family: Verdana, sans-serif;">1</span></td><td class="xl70" style="border-left: none; width: 496pt;" width="661"><b><span style="font-family: Verdana, sans-serif;">Install Linux Machine</span></b></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl66" height="20" style="border-left: none; border-top: none; height: 15.0pt;"><span style="font-family: Verdana, sans-serif;">fresh install of Centos 6.2 &amp; Centos 5.8 32bit in text mode</span></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl78" height="40" rowspan="2" style="border-bottom: .5pt solid black; border-top: none; height: 30.0pt;"><span style="font-family: Verdana, sans-serif;">2</span></td><td class="xl69" style="border-left: none; border-top: none;"><b><span style="font-family: Verdana, sans-serif;"><br><br>Install support for host command</span></b></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl66" height="20" style="border-left: none; border-top: none; height: 15.0pt;"><span style="font-family: Verdana, sans-serif;"># yum install bind-utils ( Optional -- just for host command )</span></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl78" height="120" rowspan="2" style="border-bottom: .5pt solid black; border-top: none; height: 90.0pt;"><span style="font-family: Verdana, sans-serif;">3</span></td><td class="xl69" style="border-left: none; border-top: none;"><b><span style="font-family: Verdana, sans-serif;"><br><br>Install required softwares</span></b></td></tr><tr height="100" style="height: 75.0pt;"><td class="xl67" height="100" style="border-left: none; border-top: none; height: 75.0pt; width: 496pt;" width="661"><span style="font-family: Verdana, sans-serif;">In <b>Centos 6.x</b><br># yum install samba-common pam`krb5 samba-winbind krb5-workstation<br><br>In <b>Centos 5.x</b><br># yum install samba-common pam`krb5 krb5-workstation</span></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl78" height="60" rowspan="2" style="border-bottom: .5pt solid black; border-top: none; height: 45.0pt;"><span style="font-family: Verdana, sans-serif;">4</span></td><td class="xl69" style="border-left: none; border-top: none;"><b><span style="font-family: Verdana, sans-serif;"><br><br>Check if resolution works ( OPTIONAL )</span></b></td></tr><tr height="40" style="height: 30.0pt;"><td class="xl67" height="40" style="border-left: none; border-top: none; height: 30.0pt; width: 496pt;" width="661"><span style="font-family: Verdana, sans-serif;"><span class="font5"># </span><span class="font0">host -t srv _kerberos._tcp.&lt;DOMAIN&gt;<br>(Allows a client to locate a domain controller that is running the Kerberos</span></span><br><span style="font-family: Verdana, sans-serif;"><span class="font0">KDC service for the domain)</span></span></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl78" height="160" rowspan="2" style="border-bottom: .5pt solid black; border-top: none; height: 120.0pt;"><span style="font-family: Verdana, sans-serif;">5</span></td><td class="xl70" style="border-left: none; border-top: none; width: 496pt;" width="661"><b><span style="font-family: Verdana, sans-serif;"><br><br>Make sure "hostname -f" returns answer</span></b></td></tr><tr height="140" style="height: 105.0pt;"><td class="xl67" height="140" style="border-left: none; border-top: none; height: 105.0pt; width: 496pt;" width="661"><span style="font-family: Verdana, sans-serif;">On your Linux box, set the fully-qualified hostname in /etc/sysconfig/network and&nbsp;</span><br><span style="font-family: Verdana, sans-serif;">/etc/hosts. Note that the first part of your hostname must be no longer than</span><br><span style="font-family: Verdana, sans-serif;">&nbsp;15 characters and unique in the domain<br># /etc/sysconfig/network<br>HOSTNAME=myhostname.example.com<br># /etc/hosts<br>127.0.0.1&nbsp; myhostname.example.com&nbsp; myhostname&nbsp; localhost.localdomain localhost<br># `hostname -f` should returns answer</span></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl78" height="100" rowspan="2" style="border-bottom: .5pt solid black; border-top: none; height: 75.0pt;"><span style="font-family: Verdana, sans-serif;">6</span></td><td class="xl70" style="border-left: none; border-top: none; width: 496pt;" width="661"><b><span style="font-family: Verdana, sans-serif;">Configure DNS Client ( this step is optional as long as the server names are</span></b><br><b><span style="font-family: Verdana, sans-serif;">&nbsp;resolving properly)</span></b></td></tr><tr height="80" style="height: 60.0pt;"><td class="xl67" height="80" style="border-left: none; border-top: none; height: 60.0pt; width: 496pt;" width="661"><span style="font-family: Verdana, sans-serif;">Make sure your Linux box has a properly configured DNS client (probably pointing at</span><br><span style="font-family: Verdana, sans-serif;">&nbsp;your domain controllers):<br>search example.com<br>nameserver &lt;192.168.1.10&gt;</span></td></tr><tr height="40" style="height: 30.0pt;"><td class="xl78" height="500" rowspan="3" style="border-bottom: .5pt solid black; border-top: none; height: 375.0pt;"><span style="font-family: Verdana, sans-serif;">7</span></td><td class="xl70" style="border-left: none; border-top: none; width: 496pt;" width="661"><span style="font-family: Verdana, sans-serif;">Make required entries<br>&nbsp;run the command:</span></td></tr><tr height="380" style="height: 285.0pt;"><td class="xl67" height="380" style="border-left: none; border-top: none; height: 285.0pt; width: 496pt;" width="661"><span style="font-family: Verdana, sans-serif;"># <b>authconfig \<br>--disablecache \<br>--enablewinbind \<br>--enablewinbindauth \<br>--smbsecurity=ads \<br>--smbworkgroup=&lt;TEST&gt; \<br>--smbrealm=&lt;TEST.COM&gt; \<br>--enablewinbindusedefaultdomain \<br>--winbindtemplatehomedir=/home/%U \<br>--winbindtemplateshell=/bin/bash \</b><br><b>--enablekrb5 \<br>--krb5realm=&lt;TEST.COM&gt; \<br>--krb5kdc=&lt;default kerberos KDC&gt;&nbsp; \<br>--enablekrb5kdcdns \<br>--enablekrb5realmdns \<br>--enablelocauthorize \<br>--enablemkhomedir \<br>--enablepamaccess \<br>--updateall</b></span></td></tr><tr height="80" style="height: 60.0pt;"><td class="xl67" height="80" style="border-left: none; border-top: none; height: 60.0pt; width: 496pt;" width="661"><span style="font-family: Verdana, sans-serif;">make sure to replace:<br>&lt;TEST&gt; with your domain name in all CAPS<br>&lt;TEST.COM&gt; with your domain name (FQDN) in all CAPS<br>&lt;default kerberos KDC&gt; with your KDC server FQDN in all CAPS</span></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl78" height="380" rowspan="4" style="border-bottom: .5pt solid black; border-top: none; height: 285.0pt;"><span style="font-family: Verdana, sans-serif;">8</span></td><td class="xl69" style="border-left: none; border-top: none;"><b><span style="font-family: Verdana, sans-serif;">Having Same User &amp; Group IDs across multiple client machines</span></b></td></tr><tr height="200" style="height: 150.0pt;"><td class="xl67" height="200" style="border-left: none; border-top: none; height: 150.0pt; width: 496pt;" width="661"><span style="font-family: Verdana, sans-serif;">Edit smb.conf &amp; add following lines as given below:<br>[global]<br>….<br>security = ads<br>allow trusted domains = No<br>idmap backend = idmap`rid:KPAK=5000-100000000<br>idmap uid = 5000-100000000<br>idmap gid = 5000-100000000<br>…..<br>Out of these idmap uid &amp; gid lines are already there. Make sure to change idmap uid &amp;&nbsp;</span><br><span style="font-family: Verdana, sans-serif;">idmap gid lines</span></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl72" height="20" style="border-left: none; border-top: none; height: 15.0pt; width: 496pt;" width="661"><b><span style="font-family: Verdana, sans-serif;">There is sed alternative for above work ( run these two commands):</span></b></td></tr><tr height="140" style="height: 105.0pt;"><td class="xl72" height="140" style="border-left: none; border-top: none; height: 105.0pt; width: 496pt;" width="661"><span style="font-family: Verdana, sans-serif;"># sed -i -e 's/idmap/#idmap/g' /etc/samba/smb.conf<br># sed -i -e '/#idmap\ gid/i&nbsp; \<br>allow trusted domains = No \<br>idmap backend = rid:&lt;EXAMPLE&gt;=5000-100000000 \<br>idmap uid = 5000-100000000 \<br>idmap gid = 5000-100000000<br>' /etc/samba/smb.conf</span></td></tr><tr height="21" style="height: 15.75pt;"><td class="xl78" height="181" rowspan="9" style="border-bottom: .5pt solid black; border-top: none; height: 135.75pt;"><span style="font-family: Verdana, sans-serif;">9</span></td><td class="xl68" style="border-left: none; border-top: none;"><span style="font-family: Verdana, sans-serif;"><br><b><br>Fix Home Dir Permission</b></span></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl66" height="20" style="border-left: none; border-top: none; height: 15.0pt;"><span style="font-family: Verdana, sans-serif;">Open file /etc/pam.d/system-auth</span></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl66" height="20" style="border-left: none; border-top: none; height: 15.0pt;"><span style="font-family: Verdana, sans-serif;">&amp; add umask=0077 to below line</span></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl69" height="20" style="border-left: none; border-top: none; height: 15.0pt;"><span style="font-family: Verdana, sans-serif;">session&nbsp;&nbsp;&nbsp;&nbsp; optional&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pam`mkhomedir.so</span></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl66" height="20" style="border-left: none; border-top: none; height: 15.0pt;"><span style="font-family: Verdana, sans-serif;">Now it should look like this:-</span></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl69" height="20" style="border-left: none; border-top: none; height: 15.0pt;"><span style="font-family: Verdana, sans-serif;">session&nbsp;&nbsp;&nbsp;&nbsp; optional&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pam`mkhomedir.so umask=0077</span></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl66" height="20" style="border-left: none; border-top: none; height: 15.0pt;"><span style="font-family: Verdana, sans-serif;">save &amp; exit</span></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl71" height="20" style="border-left: none; border-top: none; height: 15.0pt;"><b><span style="font-family: Verdana, sans-serif;"><br>There is a one liner for above task:-</span></b></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl71" height="20" style="border-left: none; border-top: none; height: 15.0pt;"><span style="font-family: Verdana, sans-serif;"># sed -i -e 's/pam`mkhomedir.so/pam`mkhomedir.so umask=0077/g'</span><br><span style="font-family: Verdana, sans-serif;">&nbsp;/etc/pam.d/system-auth-ac</span></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl78" height="40" rowspan="2" style="border-bottom: .5pt solid black; border-top: none; height: 30.0pt;"><span style="font-family: Verdana, sans-serif;">10</span></td><td class="xl70" style="border-left: none; border-top: none; width: 496pt;" width="661"><b><span style="font-family: Verdana, sans-serif;"><br><br>Make sure winbind runs on reboot</span></b></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl67" height="20" style="border-left: none; border-top: none; height: 15.0pt; width: 496pt;" width="661"><span style="font-family: Verdana, sans-serif;"># chkconfig winbind on</span></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl78" height="80" rowspan="4" style="border-bottom: .5pt solid black; border-top: none; height: 60.0pt;"><span style="font-family: Verdana, sans-serif;">11</span></td><td class="xl70" style="border-left: none; border-top: none; width: 496pt;" width="661"><b><span style="font-family: Verdana, sans-serif;"><br><br>Join Domain</span></b></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl66" height="20" style="border-left: none; border-top: none; height: 15.0pt;"><span style="font-family: Verdana, sans-serif;"># net ads join -S &lt;default kerberos KDC server FQDN&gt; -U &lt;administrator&gt;</span></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl66" height="20" style="border-left: none; border-top: none; height: 15.0pt;"><span style="font-family: Verdana, sans-serif;"># net ads keytab create -S &lt;default kerberos KDC server FQDN&gt; -U &lt;administrator&gt;</span></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl66" height="20" style="border-left: none; border-top: none; height: 15.0pt;"><span style="font-family: Verdana, sans-serif;">provide the &lt;administrator&gt; password for above commands</span></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl78" height="40" rowspan="2" style="border-bottom: .5pt solid black; border-top: none; height: 30.0pt;"><span style="font-family: Verdana, sans-serif;">12</span></td><td class="xl69" style="border-left: none; border-top: none;"><b><span style="font-family: Verdana, sans-serif;"><br><br>Restart Winbind</span></b></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl67" height="20" style="border-left: none; border-top: none; height: 15.0pt; width: 496pt;" width="661"><span style="font-family: Verdana, sans-serif;"># service winbind restart</span></td></tr><tr height="60" style="height: 45.0pt;"><td class="xl78" height="160" rowspan="5" style="border-bottom: .5pt solid black; border-top: none; height: 120.0pt;"><span style="font-family: Verdana, sans-serif;">13</span></td><td class="xl70" style="border-left: none; border-top: none; width: 496pt;" width="661"><span style="font-family: Verdana, sans-serif;"><br><br><b>Permission needs to be reset for domain user if local user with same name exists</b><br>( this should be done after joining to DOMAIN, otherwise users will not get the homedir or</span><br><span style="font-family: Verdana, sans-serif;">&nbsp;shell when they login)</span></td></tr><tr height="40" style="height: 30.0pt;"><td class="xl67" height="40" style="border-left: none; border-top: none; height: 30.0pt; width: 496pt;" width="661"><span style="font-family: Verdana, sans-serif;">if a username with same name as in AD exists in local system, make sure to update</span><br><span style="font-family: Verdana, sans-serif;">&nbsp;the home directory permissions for that user:</span></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl69" height="20" style="border-left: none; border-top: none; height: 15.0pt;"><span style="font-family: Verdana, sans-serif;"># chown &lt;username&gt;.domain\ users /home/&lt;direname&gt;</span></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl66" height="20" style="border-left: none; border-top: none; height: 15.0pt;"><span style="font-family: Verdana, sans-serif;">where "domain users" is the group to which all AD users are attached in linux</span></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl69" height="20" style="border-left: none; border-top: none; height: 15.0pt;"></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl75" height="80" rowspan="4" style="border-bottom: .5pt solid black; border-top: none; height: 60.0pt;"><span style="font-family: Verdana, sans-serif;">14</span></td><td class="xl73" style="border-left: none; border-top: none; width: 496pt;" width="661"><b><span style="font-family: Verdana, sans-serif;"><br>Test if it’s working fine:</span></b></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl74" height="20" style="border-left: none; border-top: none; height: 15.0pt;"><span style="font-family: Verdana, sans-serif;"># getent passwd &lt;usernameon`ad&gt;</span></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl74" height="20" style="border-left: none; border-top: none; height: 15.0pt;"><span style="font-family: Verdana, sans-serif;">should return the id details for &lt;usernameon`ad&gt;</span></td></tr><tr height="20" style="height: 15.0pt;"><td class="xl74" height="20" style="border-left: none; border-top: none; height: 15.0pt;"><span style="font-family: Verdana, sans-serif;">replace &lt;username`on_ad&gt; with any valid user in AD</span></td></tr></tbody></table></td></tr></tbody></table>

I was able to successfully join AD from Linux Machine.


Please share your experience on the above.

[1]: https://2.bp.blogspot.com/-uAyVMxYPKvY/Uo9UF4ztGrI/AAAAAAAAArA/JztgrPe8l1g/s1600/adauth.png

